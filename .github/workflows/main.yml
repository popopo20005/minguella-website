name: Auto Update Minguella Homepage

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install node-fetch@2 cheerio
        
    - name: Check Minguella app for updates
      id: check-app
      run: |
        cat > check-app.js << 'EOF'
        const fetch = require('node-fetch');
        const fs = require('fs');
        const cheerio = require('cheerio');
        
        async function checkAppUpdates() {
          try {
            console.log('ğŸ” Checking Minguella app for updates...');
            
            const response = await fetch('https://minguella-quiz-v4.netlify.app');
            const html = await response.text();
            const $ = cheerio.load(html);
            
            const title = $('title').text();
            console.log('App title:', title);
            
            const version = title.match(/v([\d.]+)/)?.[1] || '1.4.0';
            console.log('Detected version:', version);
            
            const currentData = fs.existsSync('app-info.json') 
              ? JSON.parse(fs.readFileSync('app-info.json', 'utf8'))
              : { version: '1.0.0', lastChecked: new Date().toISOString() };
            
            const newData = {
              version: version,
              lastChecked: new Date().toISOString(),
              appUrl: 'https://minguella-quiz-v4.netlify.app'
            };
            
            const hasUpdate = currentData.version !== newData.version || 
                            process.argv.includes('--force');
            
            fs.writeFileSync('app-info.json', JSON.stringify(newData, null, 2));
            
            console.log('Has update:', hasUpdate);
            console.log('Old version:', currentData.version);
            console.log('New version:', newData.version);
            
            // GitHub Actions output
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `has_update=${hasUpdate}\n`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `old_version=${currentData.version}\n`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `new_version=${newData.version}\n`);
            
            if (hasUpdate) {
              console.log(`ğŸš€ Update detected: v${currentData.version} â†’ v${newData.version}`);
            } else {
              console.log(`âœ… No updates found (current: v${newData.version})`);
            }
          } catch (error) {
            console.error('âŒ Error checking app:', error);
            process.exit(1);
          }
        }
        
        checkAppUpdates();
        EOF
        
        node check-app.js
        
    - name: Update homepage if changes detected
      if: steps.check-app.outputs.has_update == 'true'
      run: |
        cat > update-homepage.js << 'EOF'
        const fs = require('fs');
        
        function updateHomepage() {
          const newVersion = process.env.NEW_VERSION;
          const oldVersion = process.env.OLD_VERSION;
          
          console.log(`ğŸ“ Updating homepage from v${oldVersion} to v${newVersion}`);
          
          let html = fs.readFileSync('index.html', 'utf8');
          
          // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’æ›´æ–°
          html = html.replace(/v[\d.]+/g, `v${newVersion}`);
          
          // æ›´æ–°ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
          const updateComment = `<!-- Last updated: ${new Date().toISOString()} - Auto-updated from v${oldVersion} to v${newVersion} -->`;
          html = html.replace('</head>', `  ${updateComment}\n</head>`);
          
          // æ›´æ–°å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
          const updateSection = `
    <!-- Update History Section -->
    <section class="updates" style="padding: 40px 0; background: #f0f8ff;">
        <div class="container">
            <h2 class="section-title">ğŸ“ æ›´æ–°æƒ…å ±</h2>
            <div class="update-item" style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ†• v${newVersion} (${new Date().toLocaleDateString('ja-JP')})</h3>
                <p style="color: #666; margin-bottom: 10px;">ã‚¢ãƒ—ãƒªãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼</p>
                <p style="margin-top: 10px;"><a href="https://minguella-quiz-v4.netlify.app" target="_blank" class="btn btn-primary">ğŸš€ æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è©¦ã™</a></p>
            </div>
        </div>
    </section>`;
          
          // è³ªå•ç®±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å‰ã«æŒ¿å…¥
          if (html.includes('<!-- Question Box Section -->')) {
            html = html.replace('<!-- Question Box Section -->', `${updateSection}\n    <!-- Question Box Section -->`);
          }
          
          fs.writeFileSync('index.html', html);
          console.log(`âœ… Homepage updated to v${newVersion}`);
        }
        
        updateHomepage();
        EOF
        
        node update-homepage.js
      env:
        NEW_VERSION: ${{ steps.check-app.outputs.new_version }}
        OLD_VERSION: ${{ steps.check-app.outputs.old_version }}
        
    - name: Send update notification
      if: steps.check-app.outputs.has_update == 'true'
      run: |
        cat > send-notification.js << 'EOF'
        const fetch = require('node-fetch');
        
        async function sendNotifications() {
          const newVersion = process.env.NEW_VERSION;
          const oldVersion = process.env.OLD_VERSION;
          const siteUrl = process.env.SITE_URL;
          
          console.log('ğŸ“¤ Sending notifications...');
          
          // Slacké€šçŸ¥
          if (process.env.SLACK_WEBHOOK_URL) {
            const slackMessage = {
              text: "ğŸš€ Minguellaã‚¢ãƒ—ãƒªãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼",
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "ğŸ¤– è‡ªå‹•æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ "
                  }
                },
                {
                  type: "section",
                  fields: [
                    {
                      type: "mrkdwn",
                      text: `*æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³:*\nv${oldVersion}`
                    },
                    {
                      type: "mrkdwn", 
                      text: `*æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³:*\nv${newVersion}`
                    }
                  ]
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: `*ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸:* è‡ªå‹•æ›´æ–°å®Œäº†\n*æ›´æ–°æ—¥æ™‚:* ${new Date().toLocaleString('ja-JP')}`
                  }
                }
              ]
            };
            
            try {
              const response = await fetch(process.env.SLACK_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(slackMessage)
              });
              
              if (response.ok) {
                console.log('âœ… Slack notification sent');
              } else {
                console.log('âŒ Slack notification failed:', response.status);
              }
            } catch (error) {
              console.error('âŒ Slack notification error:', error.message);
            }
          }
          
          // Discordé€šçŸ¥
          if (process.env.DISCORD_WEBHOOK_URL) {
            const discordMessage = {
              username: "Minguella Auto-Update Bot",
              embeds: [{
                title: "ğŸš€ è‡ªå‹•æ›´æ–°å®Œäº†ï¼",
                color: 0x00ff00,
                fields: [
                  {
                    name: "ğŸ“Š ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´",
                    value: `v${oldVersion} â†’ v${newVersion}`,
                    inline: true
                  },
                  {
                    name: "ğŸ“… æ›´æ–°æ—¥æ™‚",
                    value: new Date().toLocaleString('ja-JP'),
                    inline: true
                  }
                ],
                footer: {
                  text: "GitHub Actionsè‡ªå‹•æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ "
                },
                timestamp: new Date().toISOString()
              }]
            };
            
            try {
              const response = await fetch(process.env.DISCORD_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(discordMessage)
              });
              
              if (response.ok) {
                console.log('âœ… Discord notification sent');
              } else {
                console.log('âŒ Discord notification failed:', response.status);
              }
            } catch (error) {
              console.error('âŒ Discord notification error:', error.message);
            }
          }
        }
        
        sendNotifications();
        EOF
        
        node send-notification.js
      env:
        NEW_VERSION: ${{ steps.check-app.outputs.new_version }}
        OLD_VERSION: ${{ steps.check-app.outputs.old_version }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        SITE_URL: ${{ secrets.SITE_URL }}
        
    - name: Commit and push changes
      if: steps.check-app.outputs.has_update == 'true'
      run: |
        git config --global user.name 'Minguella Auto-Update Bot'
        git config --global user.email 'actions@github.com'
        git add -A
        git commit -m "ğŸ¤– Auto-update to v${{ steps.check-app.outputs.new_version }}"
        git push
        
    - name: Create summary
      run: |
        echo "## ğŸ¤– è‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒã‚§ãƒƒã‚¯æ—¥æ™‚**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v${{ steps.check-app.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check-app.outputs.has_update }}" == "true" ]; then
          echo "- **æ›´æ–°æœ‰ç„¡**: âœ… æ›´æ–°ã‚ã‚Š" >> $GITHUB_STEP_SUMMARY
          echo "- **å¤‰æ›´å†…å®¹**: v${{ steps.check-app.outputs.old_version }} â†’ v${{ steps.check-app.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **æ›´æ–°æœ‰ç„¡**: âœ… æ›´æ–°ãªã—" >> $GITHUB_STEP_SUMMARY
        fi
