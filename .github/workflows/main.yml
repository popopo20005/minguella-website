name: Auto Update Minguella Homepage

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update homepage'
        required: false
        default: 'false'

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm install node-fetch@2 cheerio
        
    - name: Check Minguella app for real updates
      id: check-app
      run: |
        node -e "
        const fetch = require('node-fetch');
        const cheerio = require('cheerio');
        const fs = require('fs');
        
        async function main() {
          try {
            console.log('ğŸ” Fetching Minguella app...');
            
            // å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‹ã‚‰HTMLã‚’å–å¾—
            const response = await fetch('https://minguella-quiz-v4.netlify.app');
            const html = await response.text();
            const \$ = cheerio.load(html);
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡º
            const title = \$('title').text();
            console.log('App title:', title);
            
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’æŠ½å‡º (v1.4.0 ãªã©)
            const versionMatch = title.match(/v([\d.]+)/);
            const newVersion = versionMatch ? versionMatch[1] : '1.4.0';
            console.log('Detected version:', newVersion);
            
            // å‰å›ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
            let oldVersion = '1.0.0';
            if (fs.existsSync('app-info.json')) {
              const oldData = JSON.parse(fs.readFileSync('app-info.json', 'utf8'));
              oldVersion = oldData.version || '1.0.0';
            }
            console.log('Previous version:', oldVersion);
            
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜
            const appInfo = {
              version: newVersion,
              lastChecked: new Date().toISOString(),
              appUrl: 'https://minguella-quiz-v4.netlify.app',
              title: title
            };
            fs.writeFileSync('app-info.json', JSON.stringify(appInfo, null, 2));
            
            // æ›´æ–°åˆ¤å®š
            const hasUpdate = oldVersion !== newVersion || process.argv.includes('--force');
            
            // GitHub Actionså‡ºåŠ›
            fs.appendFileSync(process.env.GITHUB_OUTPUT, \`has_update=\${hasUpdate}\\n\`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, \`old_version=\${oldVersion}\\n\`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, \`new_version=\${newVersion}\\n\`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, \`app_title=\${title}\\n\`);
            
            if (hasUpdate) {
              console.log(\`ğŸš€ Version change detected: v\${oldVersion} â†’ v\${newVersion}\`);
            } else {
              console.log(\`âœ… No version changes (current: v\${newVersion})\`);
            }
            
            console.log('App info saved to app-info.json');
            
          } catch (error) {
            console.error('âŒ Error:', error.message);
            // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼ˆé€šçŸ¥ã¯é€ã‚‹ï¼‰
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'has_update=false\\n');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'new_version=1.4.0\\n');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'old_version=1.4.0\\n');
          }
        }
        
        main();
        "
        
    - name: Update homepage if version changed
      if: steps.check-app.outputs.has_update == 'true'
      run: |
        echo "ğŸ“ Updating homepage..."
        
        # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
        sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/v${{ steps.check-app.outputs.new_version }}/g" index.html
        
        # æ›´æ–°ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
        sed -i "s|</head>|  <!-- Auto-updated: $(date) - v${{ steps.check-app.outputs.old_version }} to v${{ steps.check-app.outputs.new_version }} -->\n</head>|" index.html
        
        echo "âœ… Homepage updated with new version"
        
    - name: Send detailed notification
      run: |
        echo "ğŸ“¤ Sending notification..."
        
        # é€šçŸ¥å†…å®¹ã‚’æº–å‚™
        if [ "${{ steps.check-app.outputs.has_update }}" == "true" ]; then
          STATUS="ğŸš€ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼"
          DETAILS="v${{ steps.check-app.outputs.old_version }} â†’ v${{ steps.check-app.outputs.new_version }}"
          ACTION="ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’è‡ªå‹•æ›´æ–°ã—ã¾ã—ãŸ"
        else
          STATUS="âœ… å®šæœŸãƒã‚§ãƒƒã‚¯å®Œäº†"
          DETAILS="ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v${{ steps.check-app.outputs.new_version }}"
          ACTION="å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        fi
        
        # Slacké€šçŸ¥ï¼ˆã‚ˆã‚Šè©³ç´°ï¼‰
        if [ ! -z "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "'"$STATUS"'",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ¤– Minguellaè‡ªå‹•ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ "
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:*\n'"$STATUS"'"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒãƒ¼ã‚¸ãƒ§ãƒ³:*\n'"$DETAILS"'"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:* '"$ACTION"'\n*ãƒã‚§ãƒƒã‚¯æ™‚åˆ»:* '"$(date)"'"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸŒ ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸"
                      },
                      "url": "'"$SITE_URL"'"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸš€ ã‚¢ãƒ—ãƒª"
                      },
                      "url": "https://minguella-quiz-v4.netlify.app"
                    }
                  ]
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL
          echo "âœ… Slack notification sent"
        fi
        
        # Discordé€šçŸ¥ï¼ˆã‚ˆã‚Šè©³ç´°ï¼‰
        if [ ! -z "$DISCORD_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "username": "Minguella Monitor Bot",
              "avatar_url": "https://cdn-icons-png.flaticon.com/512/2991/2991148.png",
              "embeds": [
                {
                  "title": "'"$STATUS"'",
                  "color": '"$([ "${{ steps.check-app.outputs.has_update }}" == "true" ] && echo "65280" || echo "3447003")"',
                  "fields": [
                    {
                      "name": "ğŸ“Š ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±",
                      "value": "'"$DETAILS"'",
                      "inline": true
                    },
                    {
                      "name": "ğŸ“… ãƒã‚§ãƒƒã‚¯æ™‚åˆ»", 
                      "value": "'"$(date)"'",
                      "inline": true
                    },
                    {
                      "name": "ğŸ¯ å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³",
                      "value": "'"$ACTION"'",
                      "inline": false
                    }
                  ],
                  "footer": {
                    "text": "GitHub Actions è‡ªå‹•ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ "
                  },
                  "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                }
              ]
            }' \
            $DISCORD_WEBHOOK_URL
          echo "âœ… Discord notification sent"
        fi
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        SITE_URL: ${{ secrets.SITE_URL }}
        
    - name: Commit changes if updated
      if: steps.check-app.outputs.has_update == 'true'
      run: |
        git config --global user.name 'Minguella Auto-Update Bot'
        git config --global user.email 'actions@github.com'
        git add .
        git commit -m "ğŸ¤– Auto-update: v${{ steps.check-app.outputs.old_version }} â†’ v${{ steps.check-app.outputs.new_version }}"
        git push
        echo "âœ… Changes committed and pushed"
        
    - name: Create detailed summary
      run: |
        echo "## ğŸ¤– Minguellaè‡ªå‹•ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š ãƒã‚§ãƒƒã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒã‚§ãƒƒã‚¯æ—¥æ™‚**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒˆãƒ«**: ${{ steps.check-app.outputs.app_title }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v${{ steps.check-app.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å‰å›ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v${{ steps.check-app.outputs.old_version }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-app.outputs.has_update }}" == "true" ]; then
          echo "- **æ›´æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸš€ **ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ¤œå‡º**" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸è‡ªå‹•æ›´æ–° & Git push" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ‰ æ›´æ–°å®Œäº†ï¼" >> $GITHUB_STEP_SUMMARY
          echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ v${{ steps.check-app.outputs.new_version }} ãŒæ¤œå‡ºã•ã‚Œã€ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’è‡ªå‹•æ›´æ–°ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **æ›´æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å¤‰æ›´ãªã—" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: å®šæœŸãƒã‚§ãƒƒã‚¯å®Œäº†" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— ãƒªãƒ³ã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸŒ ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸](${{ secrets.SITE_URL }})" >> $GITHUB_STEP_SUMMARY  
        echo "- [ğŸš€ Minguellaã‚¢ãƒ—ãƒª](https://minguella-quiz-v4.netlify.app)" >> $GITHUB_STEP_SUMMARY
