name: Auto Update Minguella Homepage

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update homepage'
        required: false
        default: 'false'

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check Minguella app with curl
      id: check-app
      run: |
        echo "ğŸ” Fetching Minguella app with curl..."
        
        # curlã§HTMLã‚’å–å¾—
        APP_HTML=$(curl -s https://minguella-quiz-v4.netlify.app)
        echo "âœ… HTML fetched successfully"
        
        # ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
        APP_TITLE=$(echo "$APP_HTML" | grep -o '<title[^>]*>[^<]*</title>' | sed 's/<[^>]*>//g' | head -1)
        echo "App title: $APP_TITLE"
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡º (v1.4.0ãªã©)
        NEW_VERSION=$(echo "$APP_TITLE" | grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+' | sed 's/v//' | head -1)
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        if [ -z "$NEW_VERSION" ]; then
          NEW_VERSION="1.4.0"
          echo "âš ï¸ Version not found in title, using default: $NEW_VERSION"
        else
          echo "ğŸ” Detected version: $NEW_VERSION"
        fi
        
        # å‰å›ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
        OLD_VERSION="1.0.0"
        if [ -f "app-info.json" ]; then
          OLD_VERSION=$(cat app-info.json | grep -o '"version":"[^"]*' | sed 's/"version":"//' | head -1)
          if [ -z "$OLD_VERSION" ]; then
            OLD_VERSION="1.0.0"
          fi
        fi
        echo "Previous version: $OLD_VERSION"
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜
        cat > app-info.json << EOF
{
  "version": "$NEW_VERSION",
  "lastChecked": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
  "appUrl": "https://minguella-quiz-v4.netlify.app",
  "title": "$APP_TITLE"
}
EOF
        
        # æ›´æ–°åˆ¤å®š
        HAS_UPDATE="false"
        if [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
          HAS_UPDATE="true"
          echo "ğŸš€ Version change detected: v$OLD_VERSION â†’ v$NEW_VERSION"
        else
          echo "âœ… No version changes (current: v$NEW_VERSION)"
        fi
        
        # å¼·åˆ¶æ›´æ–°ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
        if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
          HAS_UPDATE="true"
          echo "ğŸ”„ Force update requested"
        fi
        
        # GitHub Actionså‡ºåŠ›
        echo "has_update=$HAS_UPDATE" >> $GITHUB_OUTPUT
        echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "app_title=$APP_TITLE" >> $GITHUB_OUTPUT
        
        echo "ğŸ“ App info saved to app-info.json"
        
    - name: Update homepage if version changed
      if: steps.check-app.outputs.has_update == 'true'
      run: |
        echo "ğŸ“ Updating homepage..."
        
        OLD_VER="${{ steps.check-app.outputs.old_version }}"
        NEW_VER="${{ steps.check-app.outputs.new_version }}"
        
        # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
        if [ -f "index.html" ]; then
          # v1.4.0 å½¢å¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
          sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/v$NEW_VER/g" index.html
          
          # æ›´æ–°ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
          COMMENT="  <!-- Auto-updated: $(date) - v$OLD_VER to v$NEW_VER -->"
          sed -i "s|</head>|$COMMENT\n</head>|" index.html
          
          echo "âœ… Homepage updated: v$OLD_VER â†’ v$NEW_VER"
        else
          echo "âš ï¸ index.html not found"
        fi
        
    - name: Send detailed notification
      run: |
        echo "ğŸ“¤ Sending notification..."
        
        OLD_VER="${{ steps.check-app.outputs.old_version }}"
        NEW_VER="${{ steps.check-app.outputs.new_version }}"
        APP_TITLE="${{ steps.check-app.outputs.app_title }}"
        
        # é€šçŸ¥å†…å®¹ã‚’æº–å‚™
        if [ "${{ steps.check-app.outputs.has_update }}" == "true" ]; then
          STATUS="ğŸš€ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼"
          DETAILS="v$OLD_VER â†’ v$NEW_VER"
          ACTION="ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’è‡ªå‹•æ›´æ–°ã—ã¾ã—ãŸ"
          COLOR="65280"
        else
          STATUS="âœ… å®šæœŸãƒã‚§ãƒƒã‚¯å®Œäº†"
          DETAILS="ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v$NEW_VER"
          ACTION="å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          COLOR="3447003"
        fi
        
        # Slacké€šçŸ¥
        if [ ! -z "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "'"$STATUS"'",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ¤– Minguellaè‡ªå‹•ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ "
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:*\n'"$STATUS"'"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒãƒ¼ã‚¸ãƒ§ãƒ³:*\n'"$DETAILS"'"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒˆãƒ«:* '"$APP_TITLE"'\n*ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:* '"$ACTION"'\n*ãƒã‚§ãƒƒã‚¯æ™‚åˆ»:* '"$(date)"'"
                  }
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL
          echo "âœ… Slack notification sent"
        else
          echo "â„¹ï¸ SLACK_WEBHOOK_URL not configured"
        fi
        
        # Discordé€šçŸ¥
        if [ ! -z "$DISCORD_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "username": "Minguella Monitor Bot",
              "embeds": [
                {
                  "title": "'"$STATUS"'",
                  "color": '"$COLOR"',
                  "fields": [
                    {
                      "name": "ğŸ“Š ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±",
                      "value": "'"$DETAILS"'",
                      "inline": true
                    },
                    {
                      "name": "ğŸ“… ãƒã‚§ãƒƒã‚¯æ™‚åˆ»", 
                      "value": "'"$(date)"'",
                      "inline": true
                    },
                    {
                      "name": "ğŸ“± ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒˆãƒ«",
                      "value": "'"$APP_TITLE"'",
                      "inline": false
                    },
                    {
                      "name": "ğŸ¯ å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³",
                      "value": "'"$ACTION"'",
                      "inline": false
                    }
                  ],
                  "footer": {
                    "text": "GitHub Actions è‡ªå‹•ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ "
                  },
                  "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                }
              ]
            }' \
            $DISCORD_WEBHOOK_URL
          echo "âœ… Discord notification sent"
        else
          echo "â„¹ï¸ DISCORD_WEBHOOK_URL not configured"
        fi
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        SITE_URL: ${{ secrets.SITE_URL }}
        
    - name: Commit changes if updated
      if: steps.check-app.outputs.has_update == 'true'
      run: |
        git config --global user.name 'Minguella Auto-Update Bot'
        git config --global user.email 'actions@github.com'
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if git diff --quiet; then
          echo "â„¹ï¸ No changes to commit"
        else
          git add .
          git commit -m "ğŸ¤– Auto-update: v${{ steps.check-app.outputs.old_version }} â†’ v${{ steps.check-app.outputs.new_version }}"
          git push
          echo "âœ… Changes committed and pushed"
        fi
        
    - name: Create detailed summary
      run: |
        echo "## ğŸ¤– Minguellaè‡ªå‹•ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š ãƒã‚§ãƒƒã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒã‚§ãƒƒã‚¯æ—¥æ™‚**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒˆãƒ«**: ${{ steps.check-app.outputs.app_title }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v${{ steps.check-app.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å‰å›ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v${{ steps.check-app.outputs.old_version }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-app.outputs.has_update }}" == "true" ]; then
          echo "- **æ›´æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸš€ **ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ¤œå‡º**" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸è‡ªå‹•æ›´æ–° & Git push" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ‰ æ›´æ–°å®Œäº†ï¼" >> $GITHUB_STEP_SUMMARY
          echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ v${{ steps.check-app.outputs.new_version }} ãŒæ¤œå‡ºã•ã‚Œã€ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’è‡ªå‹•æ›´æ–°ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **æ›´æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å¤‰æ›´ãªã—" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: å®šæœŸãƒã‚§ãƒƒã‚¯å®Œäº†" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— ãƒªãƒ³ã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸŒ ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸](${{ secrets.SITE_URL }})" >> $GITHUB_STEP_SUMMARY  
        echo "- [ğŸš€ Minguellaã‚¢ãƒ—ãƒª](https://minguella-quiz-v4.netlify.app)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*æ¬¡å›è‡ªå‹•ãƒã‚§ãƒƒã‚¯: æ¯æ—¥ 0:00 UTC (æ—¥æœ¬æ™‚é–“ 9:00)*" >> $GITHUB_STEP_SUMMARY
