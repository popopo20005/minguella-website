name: Auto Update Minguella Homepage

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Check Minguella app
      id: check-app
      run: |
        echo "ðŸ” Checking Minguella app..."
        
        # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        CURRENT_VERSION="1.4.0"
        echo "Current version: v$CURRENT_VERSION"
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        echo "{\"version\":\"$CURRENT_VERSION\",\"lastChecked\":\"$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)\"}" > app-info.json
        
        # GitHub Actionså‡ºåŠ›ã‚’è¨­å®š
        echo "has_update=false" >> $GITHUB_OUTPUT
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        
        echo "âœ… Check completed"
        
    - name: Send notification test
      run: |
        echo "ðŸ“¤ Sending test notification..."
        
        # Slacké€šçŸ¥ãƒ†ã‚¹ãƒˆ
        if [ ! -z "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ðŸ¤– GitHub Actionsè‡ªå‹•ãƒã‚§ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼\nç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v${{ steps.check-app.outputs.current_version }}\nãƒã‚§ãƒƒã‚¯æ™‚åˆ»: '"$(date)"'"}' \
            $SLACK_WEBHOOK_URL
          echo "âœ… Slack notification sent"
        else
          echo "âš ï¸ SLACK_WEBHOOK_URL not set"
        fi
        
        # Discordé€šçŸ¥ãƒ†ã‚¹ãƒˆ  
        if [ ! -z "$DISCORD_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{"username":"Minguella Bot","content":"ðŸ¤– GitHub Actionsè‡ªå‹•ãƒã‚§ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼\nç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v${{ steps.check-app.outputs.current_version }}\nãƒã‚§ãƒƒã‚¯æ™‚åˆ»: '"$(date)"'"}' \
            $DISCORD_WEBHOOK_URL
          echo "âœ… Discord notification sent"
        else
          echo "âš ï¸ DISCORD_WEBHOOK_URL not set"
        fi
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        
    - name: Create summary
      run: |
        echo "## ðŸ¤– è‡ªå‹•ãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒã‚§ãƒƒã‚¯æ—¥æ™‚**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v${{ steps.check-app.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸å‹•ä½œ" >> $GITHUB_STEP_SUMMARY
        echo "- **é€šçŸ¥**: Slack/Discordé€ä¿¡å®Œäº†" >> $GITHUB_STEP_SUMMARY
