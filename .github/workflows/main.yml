# .github/workflows/auto-update.yml
name: Auto Update Minguella Homepage

on:
  schedule:
    # æ¯æ—¥ 9:00 (JST) ã«ãƒã‚§ãƒƒã‚¯
    - cron: '0 0 * * *'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install node-fetch cheerio
        
    - name: Check Minguella app for updates
      id: check-app
      run: |
        node << 'EOF'
        const fetch = require('node-fetch');
        const fs = require('fs');
        const cheerio = require('cheerio');
        
        async function checkAppUpdates() {
          try {
            // Minguellaã‚¢ãƒ—ãƒªã®ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
            const response = await fetch('https://minguella-quiz-v4.netlify.app');
            const html = await response.text();
            const $ = cheerio.load(html);
            
            // ã‚¢ãƒ—ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã‚„ç‰¹å®šã®è¦ç´ ã‹ã‚‰ï¼‰
            const title = $('title').text();
            const version = title.match(/v([\d.]+)/)?.[1] || '1.4.0';
            
            // ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
            const currentData = fs.existsSync('app-info.json') 
              ? JSON.parse(fs.readFileSync('app-info.json', 'utf8'))
              : { version: '1.4.0', lastChecked: new Date().toISOString() };
            
            const newData = {
              version: version,
              lastChecked: new Date().toISOString(),
              appUrl: 'https://minguella-quiz-v4.netlify.app',
              features: await extractFeatures($)
            };
            
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
            const hasUpdate = currentData.version !== newData.version || 
                            process.env.GITHUB_EVENT_NAME === 'workflow_dispatch';
            
            // çµæœã‚’ä¿å­˜
            fs.writeFileSync('app-info.json', JSON.stringify(newData, null, 2));
            
            // GitHub Actionså‡ºåŠ›
            console.log(`::set-output name=has_update::${hasUpdate}`);
            console.log(`::set-output name=old_version::${currentData.version}`);
            console.log(`::set-output name=new_version::${newData.version}`);
            console.log(`::set-output name=features::${JSON.stringify(newData.features)}`);
            
            if (hasUpdate) {
              console.log(`ğŸš€ Update detected: v${currentData.version} â†’ v${newData.version}`);
            } else {
              console.log(`âœ… No updates found (current: v${newData.version})`);
            }
          } catch (error) {
            console.error('Error checking app:', error);
            process.exit(1);
          }
        }
        
        async function extractFeatures($) {
          // ã‚¢ãƒ—ãƒªã®æ©Ÿèƒ½ä¸€è¦§ã‚’æŠ½å‡ºï¼ˆå®Ÿéš›ã®HTMLã®æ§‹é€ ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
          const features = [];
          
          // ä¾‹: ãƒ¡ã‚¿ã‚¿ã‚°ã‚„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰æ©Ÿèƒ½ã‚’æŠ½å‡º
          $('meta[name="description"]').each((i, el) => {
            const content = $(el).attr('content');
            if (content) features.push(content);
          });
          
          return features.length > 0 ? features : [
            'ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½', 'å­¦ç¿’åˆ†æ', 'PWAå¯¾å¿œ', 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åˆ©ç”¨'
          ];
        }
        
        checkAppUpdates();
        EOF
        
    - name: Update homepage if changes detected
      if: steps.check-app.outputs.has_update == 'true'
      run: |
        node << 'EOF'
        const fs = require('fs');
        
        function updateHomepage() {
          const newVersion = process.env.NEW_VERSION;
          const oldVersion = process.env.OLD_VERSION;
          const features = JSON.parse(process.env.FEATURES || '[]');
          
          // index.htmlã‚’èª­ã¿è¾¼ã¿
          let html = fs.readFileSync('index.html', 'utf8');
          
          // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’æ›´æ–°
          html = html.replace(/v[\d.]+/g, `v${newVersion}`);
          
          // æ›´æ–°æ—¥æ™‚ã‚’è¿½åŠ 
          const updateInfo = `
          <!-- Last updated: ${new Date().toISOString()} -->
          <!-- Auto-updated from v${oldVersion} to v${newVersion} -->`;
          
          html = html.replace('</head>', `${updateInfo}\n</head>`);
          
          // æ›´æ–°å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ /æ›´æ–°
          const updateSection = `
    <!-- Update History Section -->
    <section class="updates" style="padding: 40px 0; background: #f0f8ff;">
        <div class="container">
            <h2 class="section-title">ğŸ“ æ›´æ–°æƒ…å ±</h2>
            <div class="update-item" style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ†• v${newVersion} (${new Date().toLocaleDateString('ja-JP')})</h3>
                <p style="color: #666; margin-bottom: 10px;">ã‚¢ãƒ—ãƒªãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼</p>
                <ul style="color: #555;">
                    ${features.slice(0, 3).map(f => `<li>${f}</li>`).join('')}
                </ul>
                <p style="margin-top: 10px;"><a href="https://minguella-quiz-v4.netlify.app" target="_blank" class="btn btn-primary">ğŸš€ æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è©¦ã™</a></p>
            </div>
        </div>
    </section>`;
          
          // è³ªå•ç®±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å‰ã«æŒ¿å…¥
          html = html.replace('<!-- Question Box Section -->', `${updateSection}\n    <!-- Question Box Section -->`);
          
          // ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãæˆ»ã—
          fs.writeFileSync('index.html', html);
          
          console.log(`âœ… Homepage updated to v${newVersion}`);
        }
        
        updateHomepage();
        EOF
      env:
        NEW_VERSION: ${{ steps.check-app.outputs.new_version }}
        OLD_VERSION: ${{ steps.check-app.outputs.old_version }}
        FEATURES: ${{ steps.check-app.outputs.features }}
        
    - name: Send update notification
      if: steps.check-app.outputs.has_update == 'true'
      run: |
        node << 'EOF'
        const fetch = require('node-fetch');
        
        async function sendNotifications() {
          const newVersion = process.env.NEW_VERSION;
          const oldVersion = process.env.OLD_VERSION;
          
          // Slacké€šçŸ¥
          if (process.env.SLACK_WEBHOOK_URL) {
            const slackMessage = {
              text: "ğŸš€ Minguellaã‚¢ãƒ—ãƒªãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼",
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "ğŸ¤– è‡ªå‹•æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ "
                  }
                },
                {
                  type: "section",
                  fields: [
                    {
                      type: "mrkdwn",
                      text: `*æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³:*\nv${oldVersion}`
                    },
                    {
                      type: "mrkdwn", 
                      text: `*æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³:*\nv${newVersion}`
                    }
                  ]
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: `*ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸:* è‡ªå‹•æ›´æ–°å®Œäº†\n*æ›´æ–°æ—¥æ™‚:* ${new Date().toLocaleString('ja-JP')}`
                  }
                },
                {
                  type: "actions",
                  elements: [
                    {
                      type: "button",
                      text: {
                        type: "plain_text",
                        text: "ğŸŒ ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’ç¢ºèª"
                      },
                      url: process.env.SITE_URL || "https://your-site.netlify.app"
                    },
                    {
                      type: "button", 
                      text: {
                        type: "plain_text",
                        text: "ğŸš€ ã‚¢ãƒ—ãƒªã‚’é–‹ã"
                      },
                      url: "https://minguella-quiz-v4.netlify.app"
                    }
                  ]
                }
              ]
            };
            
            try {
              await fetch(process.env.SLACK_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(slackMessage)
              });
              console.log('âœ… Slack notification sent');
            } catch (error) {
              console.error('âŒ Slack notification failed:', error);
            }
          }
          
          // Discordé€šçŸ¥
          if (process.env.DISCORD_WEBHOOK_URL) {
            const discordMessage = {
              username: "Minguella Auto-Update Bot",
              embeds: [{
                title: "ğŸš€ è‡ªå‹•æ›´æ–°å®Œäº†ï¼",
                color: 0x00ff00,
                fields: [
                  {
                    name: "ğŸ“Š ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´",
                    value: `v${oldVersion} â†’ v${newVersion}`,
                    inline: true
                  },
                  {
                    name: "ğŸ“… æ›´æ–°æ—¥æ™‚",
                    value: new Date().toLocaleString('ja-JP'),
                    inline: true
                  },
                  {
                    name: "ğŸŒ ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸",
                    value: "[æ›´æ–°å®Œäº†](https://your-site.netlify.app)",
                    inline: true
                  }
                ],
                footer: {
                  text: "GitHub Actionsè‡ªå‹•æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ "
                },
                timestamp: new Date().toISOString()
              }]
            };
            
            try {
              await fetch(process.env.DISCORD_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(discordMessage)
              });
              console.log('âœ… Discord notification sent');
            } catch (error) {
              console.error('âŒ Discord notification failed:', error);
            }
          }
        }
        
        sendNotifications();
        EOF
      env:
        NEW_VERSION: ${{ steps.check-app.outputs.new_version }}
        OLD_VERSION: ${{ steps.check-app.outputs.old_version }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        SITE_URL: ${{ secrets.SITE_URL }}
        
    - name: Commit and push changes
      if: steps.check-app.outputs.has_update == 'true'
      run: |
        git config --global user.name 'Minguella Auto-Update Bot'
        git config --global user.email 'actions@github.com'
        git add -A
        git commit -m "ğŸ¤– Auto-update to v${{ steps.check-app.outputs.new_version }}"
        git push
        
    - name: Create summary
      run: |
        echo "## ğŸ¤– è‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒã‚§ãƒƒã‚¯æ—¥æ™‚**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v${{ steps.check-app.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ›´æ–°æœ‰ç„¡**: ${{ steps.check-app.outputs.has_update == 'true' && 'âœ… æ›´æ–°ã‚ã‚Š' || 'âœ… æ›´æ–°ãªã—' }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-app.outputs.has_update }}" == "true" ]; then
          echo "- **å¤‰æ›´å†…å®¹**: v${{ steps.check-app.outputs.old_version }} â†’ v${{ steps.check-app.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸**: è‡ªå‹•æ›´æ–°å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- **é€šçŸ¥**: Slack/Discordé€ä¿¡æ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
        fi
